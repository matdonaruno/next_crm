# ESP8266温度センサーシステム

Next.js CRMアプリケーションと連携して、リアルタイムで温度・湿度・気圧データを収集するESP8266ベースのセンサーシステムです。

## 概要

このシステムは以下のコンポーネントで構成されています：

1. **ESP8266マイコン**：WiFi経由でセンサーデータを送信
2. **温湿度センサー（AHT20）**：高精度な温度・湿度測定
3. **気圧温度センサー（BMP280）**：気圧と温度の測定
4. **Next.jsバックエンド**：データの受信、保存、表示

センサーから収集したデータは、WiFi経由でアプリケーションのAPIエンドポイントに送信され、温度管理システムに統合されます。

## ハードウェア要件

- NodeMCU ESP8266マイコン（または互換機）
- AHT20温湿度センサー
- BMP280気圧センサー
- ブレッドボードとジャンパーワイヤー
- マイクロUSBケーブル（電源・プログラミング用）
- 5V電源（USBアダプタなど）

## 配線図

ESP8266とセンサーの接続は次のように行います：

```
ESP8266 --- AHT20/BMP280（共通I2C）
3.3V    --- VCC
GND     --- GND
GPIO4   --- SDA
GPIO5   --- SCL
```

## セットアップ手順

### 1. Arduino IDEの準備

1. [Arduino IDE](https://www.arduino.cc/en/software)をインストール
2. ESP8266ボードマネージャを追加：
   - 設定 > 追加のボードマネージャURLに以下を追加：
     `https://arduino.esp8266.com/stable/package_esp8266com_index.json`
   - ツール > ボード > ボードマネージャ から「ESP8266」をインストール

### 2. 必要なライブラリのインストール

以下のライブラリをArduino IDEのライブラリマネージャからインストールします：

- **Adafruit AHTX0** - AHT20センサー用
- **Adafruit BMP280** - BMP280センサー用
- **ArduinoJson** - JSONデータ処理用

### 3. プログラムの設定

`temperature_sensor.ino`ファイルを開き、以下の設定を変更します：

1. WiFi設定：
```cpp
const char* ssid = "Your_SSID";       // WiFiネットワーク名
const char* password = "Your_PASSWORD"; // WiFiパスワード
```

2. 固定IP設定（オプション）：
```cpp
IPAddress staticIP(192, 168, 0, 100); // デバイスに割り当てるIP
IPAddress gateway(192, 168, 0, 1);    // ゲートウェイIP
IPAddress subnet(255, 255, 255, 0);   // サブネットマスク
```

3. APIエンドポイント：
```cpp
const char* serverUrl = "http://192.168.0.10:3000/api/sensor"; // あなたのNext.jsアプリのAPIエンドポイント
```

### 4. ESP8266へのプログラム書き込み

1. ESP8266をUSBケーブルでPCに接続
2. Arduino IDEで以下の設定を行う：
   - ボード：「NodeMCU 1.0 (ESP-12E Module)」
   - ポート：ESP8266が接続されたCOMポート
   - アップロードスピード：115200
3. 「スケッチをアップロード」ボタンをクリックしてプログラムを書き込む

### 5. デバイスの登録

1. センサーデバイスをPOWER ON
2. センサーがデータを送信すると、`sensor_logs`テーブルにログが作成される
3. システム管理画面（/admin/sensors）でデバイスを確認・編集
4. センサーマッピング管理画面（/admin/sensor-mappings）でセンサーのデータを温度管理アイテムにマッピング

## LEDステータス表示

ESP8266の内蔵LEDを使って、システムの状態を視覚的に確認できます：

- **起動時**：3回点滅（WiFi接続成功）
- **測定時**：短く点灯
- **データ送信時**：短く点灯（成功時）、長く点灯（エラー時）
- **WiFi未接続**：継続的に点滅

## トラブルシューティング

### センサーが認識されない場合

1. 配線を確認（特にSDA/SCL）
2. I2Cアドレスの確認（BMP280はデフォルトで0x77、変更が必要な場合あり）
3. センサーの動作電圧を確認（3.3V推奨）

### APIエンドポイントに接続できない場合

1. WiFi接続状態を確認
2. APIエンドポイントのURLが正しいか確認
3. Next.jsアプリが実行中か確認
4. ファイアウォール設定を確認

### データが表示されない場合

1. センサーデバイスがシステムに登録されているか確認
2. センサーマッピングが正しく設定されているか確認
3. デバイスのfacility_idとdepartment_idが正しく設定されているか確認

## メンテナンス

- 定期的にセンサーの動作を確認
- 長時間使用しない場合はUSB電源を抜く
- センサー表面のほこりを定期的に清掃

---

© 2023 Next CRM Temperature Management System 